---
import BlogStyles from '../components/BlogStyles.astro';

const nombre = "Eduardo";
const hoy = new Date().toLocaleDateString('es-ES', { 
  weekday: 'long', 
  year: 'numeric', 
  month: 'long', 
  day: 'numeric' 
});
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect fill='%23031420' width='64' height='64'/><circle fill='%237be0ff' cx='32' cy='32' r='18'/><path fill='%23ffffff' d='M25 34l7-12 7 12h-14z'/></svg>"
    />
    <title>Mi Blog Personal | LlullBlog</title>
    <BlogStyles />
  </head>
  <body class="home-page">
    
    <main class="container">
      
      <header class="header">
        <p class="top-label">TECH & LIFE BLOG</p>
        <h1>¡Hola {nombre}!</h1>
        <p class="date">{hoy}</p>
      </header>

      <div class="main-grid">
        
        <section class="column">
          <div class="section-header">
            <h2 class="section-title">Nueva entrada</h2>
          </div>
          
          <div class="blog-card main-form-container">
            <form id="new-entry-form" class="form-layout">
              <input 
                id="entry-title" 
                name="title" 
                type="text" 
                placeholder="Título de la publicación" 
                class="input-field" 
                required 
              />
              <textarea
                id="entry-body"
                name="body"
                placeholder="¿Qué tienes en mente hoy?"
                class="textarea-field"
                required
              ></textarea>
              <button type="submit" id="submit-btn" class="publish-button">Publicar ahora</button>
            </form>
          </div>
        </section>

        <section class="column">
          <div class="section-header">
            <h2 class="section-title">Mis entradas recientes (Nube)</h2>
            <a href="/entradas" class="view-all">VER TODAS</a>
          </div>
          
          <div id="custom-entries-list" class="entries-stack">
            <p class="muted">Cargando feed desde Supabase...</p>
          </div>
        </section>

      </div>
    </main>

    <script>
      import { createClient } from '@supabase/supabase-js';
    
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const supabase = createClient(supabaseUrl, supabaseKey);
    
      const form = document.getElementById('new-entry-form') as HTMLFormElement;
      const titleEl = document.getElementById('entry-title') as HTMLInputElement;
      const bodyEl = document.getElementById('entry-body') as HTMLTextAreaElement;
      const listEl = document.getElementById('custom-entries-list') as HTMLElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    
      function getRelativeTime(dateInput: any) {
        if (!dateInput) return '';
        const date = new Date(dateInput).getTime();
        const now = new Date().getTime();
        const diffInSeconds = Math.floor((now - date) / 1000);
        const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });
    
        if (diffInSeconds < 40) return 'hace un momento';
        if (diffInSeconds < 3600) return rtf.format(-Math.floor(diffInSeconds / 60), 'minutes');
        if (diffInSeconds < 86400) return rtf.format(-Math.floor(diffInSeconds / 3600), 'hours');
        if (diffInSeconds < 604800) return rtf.format(-Math.floor(diffInSeconds / 86400), 'days');
        return new Date(dateInput).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
      }
    
      const renderEntries = async () => {
        const { data: entries, error } = await supabase
          .from('entradas')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(5);
    
        if (error) {
          listEl.innerHTML = '<p class="muted">Error de conexión.</p>';
          return;
        }
    
        if (!entries || entries.length === 0) {
          listEl.innerHTML = '<div class="blog-card entry-cell"><p>Diario vacío</p></div>';
          return;
        }
    
        listEl.innerHTML = '';
        entries.forEach((entry) => {
          const card = document.createElement('article');
          // 'blog-card' da el fondo y borde, 'entry-cell' el padding
          card.className = 'blog-card entry-cell'; 
          card.innerHTML = `
            <div class="card-top">
              <h3 class="entry-title">${entry.title}</h3>
              <span class="time-tag">${getRelativeTime(entry.created_at)}</span>
            </div>
            <p class="entry-content">${entry.body}</p>
          `;
          listEl.appendChild(card);
        });
      };
    
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = titleEl.value.trim();
        const body = bodyEl.value.trim();
    
        if (!title || !body) return;
    
        submitBtn.disabled = true;
        submitBtn.innerText = 'Publicando...';
    
        const { error } = await supabase.from('entradas').insert([{ title, body }]);
    
        if (error) {
          console.error(error);
        } else {
          form.reset();
          await renderEntries();
        }
    
        submitBtn.disabled = false;
        submitBtn.innerText = 'Publicar ahora';
      });
    
      renderEntries();
    </script>
  </body>
</html>