---
import BlogStyles from '../components/BlogStyles.astro';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect fill='%230f1629' width='64' height='64'/><circle fill='%2399b4ff' cx='32' cy='32' r='18'/><path fill='%23ffffff' d='M25 34l7-12 7 12h-14z'/></svg>"
    />
    <title>√öltimas Entradas | LlullBlog</title>
    <BlogStyles />
    <style>
      .delete-btn {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.4);
        padding: 5px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        margin-top: 1rem;
        transition: all 0.2s;
      }
      .delete-btn:hover {
        background: #ff6b6b;
        color: white;
      }
    </style>
  </head>
  <body class="entradas-page">
    <header>
      <h1>√öltimas Entradas</h1>
    </header>

    <main id="main-container">
      <p class="muted" style="text-align: center;">Cargando entradas...</p>
    </main>

    <footer>
      <p style="text-align: center; margin-top: 2rem;">
        <a href="/">‚Üê Volver al inicio</a>
      </p>
    </footer>

    <script>
      import { createClient } from '@supabase/supabase-js';
    
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const supabase = createClient(supabaseUrl, supabaseKey);
    
      // A√±adimos ": any" para que el compilador no d√© error
      const getRelativeTime = (dateInput: any) => {
        if (!dateInput) return '';
        
        // Convertimos a n√∫mero (milisegundos) para comparar
        const date = new Date(dateInput).getTime();
        const now = new Date().getTime();
        
        // Calculamos la diferencia
        const diffInSeconds = Math.floor((now - date) / 1000);
        const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });
    
        if (diffInSeconds < 40) return 'hace un momento';
        if (diffInSeconds < 3600) return rtf.format(-Math.floor(diffInSeconds / 60), 'minutes');
        if (diffInSeconds < 86400) return rtf.format(-Math.floor(diffInSeconds / 3600), 'hours');
        if (diffInSeconds < 604800) return rtf.format(-Math.floor(diffInSeconds / 86400), 'days');
        
        return new Date(dateInput).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
      };
    
      const renderEntries = async () => {
        const container = document.getElementById('main-container');
        if (!container) return;
    
        const { data: entries, error } = await supabase
          .from('entradas')
          .select('*')
          .order('created_at', { ascending: false });
    
        if (error) {
          container.innerHTML = '<p class="muted">Error al cargar datos.</p>';
          return;
        }
    
        if (!entries || entries.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align:center;">No hay entradas todav√≠a.</p>';
          return;
        }
    
        container.innerHTML = '';
        entries.forEach((entry) => {
          const section = document.createElement('section');
          section.className = 'entry-card';
          
          // Llamamos a la funci√≥n con la columna correcta
          const timeLabel = getRelativeTime(entry.created_at);
          
          section.innerHTML = `
            <h2>${entry.title}</h2>
            <p>${entry.body}</p>
            <p class="muted"><small>üïí ${timeLabel}</small></p>
            <button class="delete-btn" data-id="${entry.id}">Eliminar entrada</button>
          `;
          
          section.querySelector('.delete-btn')?.addEventListener('click', async () => {
            if (confirm('¬øSeguro que quieres borrar esta entrada?')) {
              const { error: delError } = await supabase.from('entradas').delete().eq('id', entry.id);
              if (!delError) renderEntries();
              else alert('Error al borrar');
            }
          });
    
          container.appendChild(section);
        });
      };
    
      renderEntries();
    </script>
  </body>
</html>