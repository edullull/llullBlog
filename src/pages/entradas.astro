---
import BlogStyles from '../components/BlogStyles.astro';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Archivo de Entradas | LlullBlog</title>
    <BlogStyles />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <p class="top-label">HISTORIAL COMPLETO</p>
        <h1>Todas las Publicaciones</h1>
      </header>

      <div id="grid-container" class="grid-all">
        <p class="muted">Cargando catálogo...</p>
      </div>

      <footer style="text-align: center; margin-top: 2rem; padding-bottom: 5rem;">
        <a href="/" class="view-all" style="font-size: 0.9rem; padding: 12px 24px;">
          ← Volver al inicio
        </a>
      </footer>
    </main>

    <script>
      import { createClient } from '@supabase/supabase-js';
      
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const supabase = createClient(supabaseUrl, supabaseKey);

      // Función para calcular el tiempo relativo
      function getRelativeTime(dateInput: any) {
        if (!dateInput) return '';
        const date = new Date(dateInput).getTime();
        const now = new Date().getTime();
        const diffInSeconds = Math.floor((now - date) / 1000);
        const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });

        if (diffInSeconds < 40) return 'ahora mismo';
        if (diffInSeconds < 3600) return rtf.format(-Math.floor(diffInSeconds / 60), 'minutes');
        if (diffInSeconds < 86400) return rtf.format(-Math.floor(diffInSeconds / 3600), 'hours');
        if (diffInSeconds < 604800) return rtf.format(-Math.floor(diffInSeconds / 86400), 'days');
        return new Date(dateInput).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
      }

      const render = async () => {
        const grid = document.getElementById('grid-container');
        if (!grid) return;

        const { data, error } = await supabase
          .from('entradas')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          grid.innerHTML = '<p class="muted">Error al cargar las entradas.</p>';
          return;
        }

        if (data && data.length > 0) {
          grid.innerHTML = data.map(p => `
            <article class="blog-card entry-cell" style="display: flex; flex-direction: column; min-height: 250px;">
              <div class="card-top">
                <h2 class="entry-title">${p.title}</h2>
                <span class="time-tag">${getRelativeTime(p.created_at)}</span>
              </div>
              <p class="entry-content" style="flex-grow: 1;">${p.body}</p>
              <button class="btn-delete" data-id="${p.id}">Eliminar</button>
            </article>
          `).join('');

          grid.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (confirm('¿Eliminar esta entrada permanentemente?')) {
                const id = btn.getAttribute('data-id');
                const { error: delError } = await supabase.from('entradas').delete().eq('id', id);
                if (!delError) render();
              }
            });
          });
        } else {
          grid.innerHTML = '<p class="muted">No hay publicaciones.</p>';
        }
      };

      render();
    </script>
  </body>
</html>